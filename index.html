<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5.0,user-scalable=yes" />
<title>ç²—å¤§ã”ã¿æ¡å¯¸ã‚µãƒãƒ¼ãƒˆï¼ˆæ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ï¼‰</title>
<style>
  body{
    font-family: system-ui, -apple-system, sans-serif;
    line-height: 1.6; margin: 0; background-color: #f0f2f5;
    user-select: none; -webkit-user-select: none;
  }
  #mainWrapper { padding: 16px; padding-bottom: 80px; max-width: 600px; margin: 0 auto; }
  h1{ font-size:1.2rem; margin:0 0 16px; color:#333; text-align:center; }
  
  /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
  .tab-group { display: flex; gap: 8px; margin-bottom: 16px; }
  .tab-btn {
    flex: 1; padding: 12px; border: none; border-radius: 8px;
    background: #e4e6eb; color: #666; font-size: 1rem; font-weight: bold;
    cursor: pointer; transition: all 0.2s; text-align: center;
    border: 2px solid transparent;
  }
  .tab-btn.active {
    background: #fff; color: #2b74ff; border-color: #2b74ff;
    box-shadow: 0 2px 5px rgba(43,116,255,0.2);
  }
  
  .panel{ 
    border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:20px; 
    background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .hidden { display: none !important; }

  h2 { font-size: 1rem; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 12px; }
  .col{ flex:1 1 100%; }
  
  canvas{
    width:100%; height:auto; display:block;
    border:2px dashed #ccc; border-radius:8px; background:#fafafa;
    touch-action:none; margin-bottom: 8px;
  }
  
  button, input[type="file"]::file-selector-button {
    background-color: #fff; border: 1px solid #ccc; border-radius: 6px;
    padding: 8px 12px; font-size: 14px; color: #333; cursor: pointer;
    touch-action: manipulation;
  }
  button:active { background-color: #eef; transform: translateY(1px); }
  button.tool-btn { border-color: #2b74ff; color: #2b74ff; font-weight: bold; }
  
  .btn-row{ margin:8px 0; display:flex; flex-wrap:wrap; gap:12px; justify-content: center; }
  
  .muted{ color:#666; font-size:0.85em; }
  .result-text{ font-size:1.1rem; padding:4px 0; font-weight:bold; color:#0056b3; text-align: right; }
  .small{ font-size:0.85em; color:#666; }

  /* é›»è©±ç”¨ãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ */
  #memoPanel {
    background-color: #fff8e1; border: 2px solid #ffb300; 
    text-align: center; position: relative;
  }
  .memo-header {
    background: #ffb300; color: #fff; display: inline-block;
    padding: 4px 12px; border-radius: 99px; font-size: 0.85rem; font-weight: bold;
    margin-bottom: 12px;
  }
  .memo-row {
    display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc;
    padding: 8px 0; font-size: 1.1rem;
  }
  .memo-label { color: #666; }
  .memo-val { font-weight: bold; color: #333; }
  
  .total-box {
    margin-top: 12px; background: #fff; padding: 12px; border-radius: 8px;
    border: 2px solid #2b74ff;
  }
  .total-label { color: #2b74ff; font-size: 0.9rem; font-weight: bold; display: block; }
  .total-val { font-size: 2.5rem; font-weight: 900; color: #333; line-height: 1.2; }
  .unit { font-size: 1rem; font-weight: normal; color: #666; }

  .call-btn {
    display: block; width: 100%; padding: 14px 0; margin-top: 16px;
    background-color: #28a745; color: white; font-weight: bold; font-size: 1.2rem;
    text-align: center; text-decoration: none; border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15); border: none;
  }
  .call-sub { font-size: 0.75rem; font-weight: normal; display:block; margin-top: 2px;}
</style>
</head>
<body>

<div id="mainWrapper">
  <h1>ç²—å¤§ã”ã¿æ¡å¯¸ã‚µãƒãƒ¼ãƒˆ</h1>
  
  <div class="tab-group">
    <button class="tab-btn active" onclick="switchMode('sum')">ğŸ“¦ 3è¾ºåˆè¨ˆ<br><span style="font-size:0.7rem">ã‚¿ãƒ³ã‚¹ãƒ»ç®±ãƒ»æ£š</span></button>
    <button class="tab-btn" onclick="switchMode('max')">ğŸ“ æœ€å¤§è¾º<br><span style="font-size:0.7rem">æœºãƒ»æ£’ãƒ»ãã®ä»–</span></button>
  </div>

  <p class="muted" id="modeDesc" style="text-align:center;">
    å¹…ãƒ»å¥¥è¡Œãƒ»é«˜ã•ã‚’æ¸¬ã‚Šã€åˆè¨ˆã‚’å‡ºã—ã¾ã™ã€‚
  </p>

  <div class="panel" id="panelTop">
    <h2 id="titleTop">â‘  ä¸Šã‹ã‚‰ã®å†™çœŸ (W / D)</h2>
    <input type="file" id="topFile" accept="image/*" style="width:100%"/>
    <div class="btn-row">
      <button class="tool-btn" id="topScale">ğŸ“ ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š</button>
      <button id="topManual">ğŸ‘† æ‰‹å‹•æŒ‡å®š</button>
    </div>
    <div class="col">
      <canvas id="topCanvas" width="640" height="480"></canvas>
      <div class="small" id="topMsg">å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="result-text" id="topInfo">æ¸¬å®šå€¤: -</div>
    </div>
  </div>

  <div class="panel" id="panelSide">
    <h2>â‘¡ æ¨ªã‹ã‚‰ã®å†™çœŸ (é«˜ã• H)</h2>
    <input type="file" id="sideFile" accept="image/*" style="width:100%"/>
    <div class="btn-row">
      <button class="tool-btn" id="sideScale">ğŸ“ ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š</button>
      <button id="sideManual">ğŸ‘† æ‰‹å‹•æŒ‡å®š</button>
    </div>
    <div class="col">
      <canvas id="sideCanvas" width="640" height="480"></canvas>
      <div class="small" id="sideMsg">å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="result-text" id="sideInfo">H: -</div>
    </div>
  </div>

  <div class="panel hidden" id="memoPanel">
    <span class="memo-header">ğŸ“ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã¸ã®å›ç­”ãƒ¡ãƒ¢</span>
    
    <div id="detailsBox" style="text-align:left; margin-bottom:8px;">
      <div class="memo-row">
        <span class="memo-label">å¹… (W)</span><span class="memo-val" id="resW">-</span>
      </div>
      <div class="memo-row">
        <span class="memo-label">å¥¥è¡Œ (D)</span><span class="memo-val" id="resD">-</span>
      </div>
      <div class="memo-row" id="rowH">
        <span class="memo-label">é«˜ã• (H)</span><span class="memo-val" id="resH">-</span>
      </div>
    </div>

    <div class="total-box">
      <span class="total-label" id="answerLabel">èã‹ã‚ŒãŸã‚‰ã“ã‚Œã‚’ç­”ãˆã‚‹</span>
      <span class="total-val" id="finalVal">0</span> <span class="unit">cm</span>
    </div>

    <a href="tel:0570070053" class="call-btn">
      ğŸ“ é›»è©±ã§ç”³ã—è¾¼ã‚€
      <span class="call-sub">æºå¸¯: 0570-07-0053 / å›ºå®š: 0120-79-0053</span>
    </a>
    <p class="muted" style="margin-top:8px;font-size:0.75em;">
      â€»å“åã¨ã‚µã‚¤ã‚ºã‚’ä¼ãˆã¦ãã ã•ã„ã€‚<br>
      å—ä»˜: æœˆï½åœŸ 9:00ï½17:00 (ç¥æ—¥ã‚‚å—ä»˜)
    </p>
  </div>

</div>

<script>
var REAL_LEN_MM = 100; // 100mmåŸºæº–
function $(id){ return document.getElementById(id); }

// currentMode: 'sum' (3è¾ºåˆè¨ˆ) | 'max' (æœ€å¤§è¾º)
var currentMode = 'sum';

var S = {
  top:  { bg:null, mode:"idle", clicks:[], rect:null, scale:null, W:null, D:null, scalePoints:[], aimingCursor:null },
  side: { bg:null, mode:"idle", clicks:[], rect:null, scale:null, H:null, scalePoints:[], aimingCursor:null }
};

window.switchMode = function(mode){
  currentMode = mode;
  var tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(t => t.classList.remove('active'));
  
  if(mode==='sum') tabs[0].classList.add('active');
  else tabs[1].classList.add('active');

  // UIåˆ‡ã‚Šæ›¿ãˆ
  var panelSide = $('panelSide');
  var titleTop = $('titleTop');
  var desc = $('modeDesc');
  var rowH = $('rowH');
  var answerLabel = $('answerLabel');

  if(mode === 'sum'){
    panelSide.classList.remove('hidden');
    rowH.classList.remove('hidden');
    titleTop.textContent = "â‘  ä¸Šã‹ã‚‰ã®å†™çœŸ (W / D)";
    desc.innerHTML = "ã‚¿ãƒ³ã‚¹ã‚„ç®±ãªã©ã€<b>å¹…ãƒ»å¥¥è¡Œãƒ»é«˜ã•ã®åˆè¨ˆ</b>ã‚’æ¸¬ã‚Šã¾ã™ã€‚";
    answerLabel.textContent = "3è¾ºåˆè¨ˆ";
  } else {
    panelSide.classList.add('hidden'); 
    rowH.classList.add('hidden');
    titleTop.textContent = "â‘  çœŸä¸Šã‹ã‚‰ã®å†™çœŸ";
    desc.innerHTML = "æœºã‚„æ£’ãªã©ã€<b>ä¸€ç•ªé•·ã„è¾ºï¼ˆã¾ãŸã¯å¾„ï¼‰</b>ã‚’æ¸¬ã‚Šã¾ã™ã€‚";
    answerLabel.textContent = "æœ€å¤§ã‚µã‚¤ã‚º";
  }
  calcResult();
};

function loadToCanvas(file, canvasId, kind){
  if(!file) return;
  var canvas = $(canvasId); var ctx = canvas.getContext("2d"); var img = new Image();
  img.onload = function(){
    var maxW = 800, maxH = 800; var w = img.naturalWidth, h = img.naturalHeight;
    var s = Math.min(maxW/w, maxH/h);
    canvas.width = Math.round(w*s); canvas.height = Math.round(h*s);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    S[kind].bg = ctx.getImageData(0,0,canvas.width,canvas.height);
    
    // ãƒªã‚»ãƒƒãƒˆ
    S[kind].mode = "idle"; 
    S[kind].clicks = []; 
    S[kind].rect = null;
    S[kind].scale = null; 
    S[kind].scalePoints = []; 
    S[kind].aimingCursor = null;
    
    if(kind==="top"){ S.top.W=null; S.top.D=null; } else { S.side.H=null; }
    
    $(kind+"Msg").innerHTML = "ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„";
    updateInfo(kind); drawOverlay(kind);
  };
  var reader = new FileReader();
  reader.onload = function(e){ img.src = e.target.result; };
  reader.readAsDataURL(file);
}

function drawOverlay(kind){
  var canvas = $(kind+"Canvas"); var ctx = canvas.getContext("2d"); var st = S[kind];
  if(st.bg) ctx.putImageData(st.bg,0,0); else ctx.clearRect(0,0,canvas.width,canvas.height);

  // å®šè¦ or æ‰‹å‹•æŒ‡å®šã®ã€Œç‚¹ã€ã‚’æç”»
  var points = [];
  if(st.mode==="scale" || st.mode==="manual") {
     points = (st.clicks.length > 0) ? st.clicks : [];
     // ã‚¹ã‚±ãƒ¼ãƒ«ç¢ºå®šæ¸ˆã¿ãªã‚‰ãã¡ã‚‰ã‚’è¡¨ç¤º
     if(st.mode==="scale" && st.scalePoints.length>0) points = st.scalePoints;
  } else {
     // idleæ™‚ãªã©
     if(st.scalePoints.length>0) points = st.scalePoints;
  }

  if(points.length > 0){
    ctx.lineWidth=2;
    for(var i=0; i<points.length; i++){
      var p = points[i];
      ctx.fillStyle="#2b74ff"; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle="#fff"; ctx.strokeStyle="#000"; ctx.font="bold 14px sans-serif";
      ctx.strokeText(i+1, p.x+8, p.y-8); ctx.fillText(i+1, p.x+8, p.y-8);
    }
    // ã‚¹ã‚±ãƒ¼ãƒ«ã®ç·š
    if(st.mode==="scale" && points.length===2){
      ctx.strokeStyle="#2b74ff"; ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); ctx.lineTo(points[1].x, points[1].y); ctx.stroke();
    }
  }

  // â˜…è¿½åŠ æ©Ÿèƒ½ï¼šæ‰‹å‹•æŒ‡å®šä¸­ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŸ©å½¢ (1ç‚¹ç›®ã¨ã‚«ãƒ¼ã‚½ãƒ«ã‚’çµã¶æ )
  if(st.mode === "manual" && st.clicks.length === 1 && st.aimingCursor){
    var p1 = st.clicks[0];
    var p2 = st.aimingCursor;
    var rx = Math.min(p1.x, p2.x);
    var ry = Math.min(p1.y, p2.y);
    var rw = Math.abs(p1.x - p2.x);
    var rh = Math.abs(p1.y - p2.y);

    ctx.strokeStyle = "#ff3b30";
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]); // ç‚¹ç·š
    ctx.strokeRect(rx, ry, rw, rh);
    ctx.setLineDash([]); // å®Ÿç·šã«æˆ»ã™
  }

  // ã‚«ãƒ¼ã‚½ãƒ«
  if(st.aimingCursor){
    var cx = st.aimingCursor.x; var cy = st.aimingCursor.y;
    ctx.strokeStyle = "#ff00ff"; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(cx-20, cy); ctx.lineTo(cx+20, cy); ctx.moveTo(cx, cy-20); ctx.lineTo(cx, cy+20); ctx.stroke();
    ctx.beginPath(); ctx.arc(cx, cy, 15, 0, Math.PI*2); ctx.stroke();
  }

  // çŸ©å½¢ï¼ˆæ‰‹å‹•æŒ‡å®šã®ç¢ºå®šå¾Œï¼‰
  if(st.rect){
    ctx.strokeStyle="#ff3b30"; ctx.lineWidth=3; ctx.strokeRect(st.rect.x, st.rect.y, st.rect.w, st.rect.h);
  }
}

// æŒ‡ã‚ªãƒ•ã‚»ãƒƒãƒˆ 30px
function getCanvasPoint(ev, canvas){
  var rect = canvas.getBoundingClientRect(); var clientX, clientY;
  if(ev.touches && ev.touches.length>0){ clientX = ev.touches[0].clientX; clientY = ev.touches[0].clientY; }
  else if(ev.changedTouches && ev.changedTouches.length>0){ clientX = ev.changedTouches[0].clientX; clientY = ev.changedTouches[0].clientY; }
  else { clientX = ev.clientX; clientY = ev.clientY; }
  clientY -= 30; 
  var scaleX = canvas.width/rect.width; var scaleY = canvas.height/rect.height;
  return { x:(clientX-rect.left)*scaleX, y:(clientY-rect.top)*scaleY };
}

function setupCanvasEvents(kind){
  var canvas = $(kind+"Canvas"); var st = S[kind];
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  var handleStart = function(ev){
    if(st.mode==="idle") return;
    ev.preventDefault();
    st.aimingCursor = getCanvasPoint(ev, canvas);
    drawOverlay(kind);
  };

  var handleMove = function(ev){
    if(st.mode==="idle") return;
    ev.preventDefault();
    st.aimingCursor = getCanvasPoint(ev, canvas);
    drawOverlay(kind);
  };

  var handleEnd = function(ev){
    if(st.mode==="idle") return;
    ev.preventDefault();
    if(st.aimingCursor){
      st.clicks.push(st.aimingCursor);
      st.aimingCursor = null; 
      
      // 3ç‚¹ç›®ä»¥ä¸Šãªã‚‰å¤ã„ã®ã‚’æ¶ˆã™ï¼ˆã‚„ã‚Šç›´ã—ï¼‰
      if(st.clicks.length > 2) st.clicks.shift();

      drawOverlay(kind);

      // 2ç‚¹ãŸã¾ã£ãŸã‚‰ç¢ºå®šå‡¦ç†
      if(st.clicks.length === 2){
        if(st.mode === "scale") commitScale(kind);
        else if(st.mode === "manual") applyManualRect(kind);
      }
    }
  };

  // Touch
  canvas.addEventListener("touchstart", handleStart, {passive:false});
  canvas.addEventListener("touchmove", handleMove, {passive:false});
  canvas.addEventListener("touchend", handleEnd, {passive:false});
  // Mouse
  canvas.addEventListener("mousedown", handleStart);
  canvas.addEventListener("mousemove", handleMove);
  canvas.addEventListener("mouseup", handleEnd);
}

function commitScale(kind){
  var st=S[kind]; var a=st.clicks[0], b=st.clicks[1];
  var dist=Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2));
  if(dist<5){ alert("ç‚¹ãŒè¿‘ã™ãã¾ã™"); st.clicks=[]; drawOverlay(kind); return; }
  
  st.scale=REAL_LEN_MM/dist; 
  st.scalePoints=[a,b]; 
  st.clicks=[]; 
  st.mode="idle"; // è¨­å®šçµ‚ã‚ã£ãŸã‚‰idleã¸
  
  $(kind+"Msg").innerHTML="ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šå®Œäº†"; 
  drawOverlay(kind); 
  updateInfo(kind);
}

function applyManualRect(kind){
  var st=S[kind]; 
  
  // ã‚¹ã‚±ãƒ¼ãƒ«æœªè¨­å®šãªã‚‰è­¦å‘Š
  if(!st.scale){ 
    alert("å…ˆã«ã€Œã‚¹ã‚±ãƒ¼ãƒ«è¨­å®šã€ã‚’è¡Œã£ã¦ãã ã•ã„");
    st.clicks = [];
    st.mode = "idle";
    drawOverlay(kind);
    return;
  }

  // 2ç‚¹ã‹ã‚‰çŸ©å½¢ã‚’ç”Ÿæˆ
  var p1 = st.clicks[0];
  var p2 = st.clicks[1];
  st.rect = {
    x: Math.min(p1.x, p2.x),
    y: Math.min(p1.y, p2.y),
    w: Math.abs(p1.x - p2.x),
    h: Math.abs(p1.y - p2.y)
  };

  // ã‚µã‚¤ã‚ºè¨ˆç®—
  if(kind==="top"){ 
    st.W = st.rect.w * st.scale; 
    st.D = st.rect.h * st.scale; 
  } else { 
    st.H = st.rect.h * st.scale; 
  }

  st.clicks = [];
  st.mode = "idle"; // å®Œäº†ã—ãŸã‚‰idleã¸
  updateInfo(kind);
  drawOverlay(kind);
}

function updateInfo(kind){
  var st=S[kind]; var el=$(kind+"Info");
  if(kind==="top"){
    if(currentMode === 'max'){
      var maxVal = Math.max(st.W||0, st.D||0);
      el.textContent = "æœ€å¤§: " + (maxVal>0 ? maxVal.toFixed(0) : "-") + " mm";
    } else {
      el.textContent = "W: "+(st.W?st.W.toFixed(0):"-")+" / D: "+(st.D?st.D.toFixed(0):"-")+" mm";
    }
  } else {
    el.textContent = "H: "+(st.H?st.H.toFixed(0):"-")+" mm";
  }
  calcResult();
}

function calcResult(){
  var W=S.top.W||0, D=S.top.D||0, H=S.side.H||0;
  var memoPanel = $("memoPanel");
  var finalVal = $("finalVal");
  var resW = $("resW"); var resD = $("resD"); var resH = $("resH");

  var isReady = false;
  var finalCm = 0;

  if(currentMode === 'sum'){
    // 3è¾ºåˆè¨ˆãƒ¢ãƒ¼ãƒ‰
    if(W>0 && D>0 && H>0){
      var total = W+D+H;
      finalCm = Math.round(total/10);
      resW.textContent = Math.round(W/10) + "cm";
      resD.textContent = Math.round(D/10) + "cm";
      resH.textContent = Math.round(H/10) + "cm";
      isReady = true;
    }
  } else {
    // æœ€å¤§è¾ºãƒ¢ãƒ¼ãƒ‰ (æœºãªã©)
    if(W>0 || D>0){
      var maxVal = Math.max(W, D);
      finalCm = Math.round(maxVal/10);
      resW.textContent = Math.round(W/10) + "cm";
      resD.textContent = Math.round(D/10) + "cm";
      resH.textContent = "-"; // é«˜ã•ä¸è¦
      isReady = true;
    }
  }

  if(isReady){
    memoPanel.classList.remove('hidden');
    finalVal.textContent = finalCm;
  } else {
    memoPanel.classList.add('hidden');
  }
}

// åˆæœŸåŒ–
window.onload = function(){
  // ãƒœã‚¿ãƒ³æ“ä½œ
  $("topScale").onclick = function(){ S.top.mode="scale"; S.top.clicks=[]; $("topMsg").innerText="ã‚¹ã‚±ãƒ¼ãƒ«ç´™ã®ä¸¡ç«¯(2ç‚¹)ã‚’ã‚¿ãƒƒãƒ—"; drawOverlay("top"); };
  $("sideScale").onclick = function(){ S.side.mode="scale"; S.side.clicks=[]; $("sideMsg").innerText="ã‚¹ã‚±ãƒ¼ãƒ«ç´™ã®ä¸¡ç«¯(2ç‚¹)ã‚’ã‚¿ãƒƒãƒ—"; drawOverlay("side"); };
  
  $("topManual").onclick = function(){ S.top.mode="manual"; S.top.rect=null; S.top.clicks=[]; $("topMsg").innerText="å¯¾è§’ç·šã®ä¸¡ç«¯(2ç‚¹)ã‚’ã‚¿ãƒƒãƒ—"; drawOverlay("top"); };
  $("sideManual").onclick = function(){ S.side.mode="manual"; S.side.rect=null; S.side.clicks=[]; $("sideMsg").innerText="å¯¾è§’ç·šã®ä¸¡ç«¯(2ç‚¹)ã‚’ã‚¿ãƒƒãƒ—"; drawOverlay("side"); };
  
  // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
  $("topFile").onchange = function(e){ loadToCanvas(e.target.files[0], "topCanvas", "top"); };
  $("sideFile").onchange = function(e){ loadToCanvas(e.target.files[0], "sideCanvas", "side"); };
  
  setupCanvasEvents("top"); setupCanvasEvents("side");
  switchMode('sum'); 
};
</script>
</body>
</html>
